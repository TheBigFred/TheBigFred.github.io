
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index, follow">

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="../theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../theme/font-awesome/css/solid.css">


    <link href="http://thebigfred.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="fgeDoc's Atom">




    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">

<meta name="author" content="FGE">
<meta name="description" content="CMake est un outil open-source et cross-platform qui permet la gestion du processus de compilation d&#39;une application et ce de manière indépendante du système d&#39;exploitation …">
<meta name="keywords" content="cmd-line, GNU-Tools">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<meta property="og:site_name" content="fgeDoc's"/>
<meta property="og:title" content="Introduction à CMake"/>
<meta property="og:description" content="CMake est un outil open-source et cross-platform qui permet la gestion du processus de compilation d&#39;une application et ce de manière indépendante du système d&#39;exploitation …"/>
<meta property="og:locale" content="fr_BE"/>
<meta property="og:url" content="../drafts/introduction-a-cmake.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-04-29 19:43:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="../author/fge.html">
<meta property="article:section" content="devtools"/>
<meta property="article:tag" content="cmd-line"/>
<meta property="article:tag" content="GNU-Tools"/>
<meta property="og:image" content="">

  <title>fgeDoc's &ndash; Introduction à CMake</title>

</head>
<body>
  <aside>
    <div>
      <h1><a href="../index.html">FGE Doc's</a></h1>

<p>Sharing notes</p>      <nav>
        <h2>
          <a href="../index.html">
            <span class="fa fa-home"></span>
            <small> Home</small>
          </a>
        </h2>
        <ul class="list">
        </ul>
      </nav>
      <nav>
        <h2>
          <a href="../categories.html">
            <span class="fa fa-folder-open"></span>
            <small> Catégories</small>
          </a>
        </h2>
	      <ul class="list">
          <li><a href="../category/devtools.html">devtools (5)</a></li>
          <li><a href="../category/linux.html">linux (4)</a></li>
        </ul>
      </nav>
      <nav>
        <h2>
          <a href="../tags.html">
            <span class="fa fa-tags"></span>
            <small> Tags</small>
          </a>
        </h2>
        <ul class="list">          <li><a href="../tag/cmd-line.html">cmd-line (6)</a></li>
          <li><a href="../tag/gnu-tools.html">GNU-Tools (5)</a></li>
          <li><a href="../tag/xfce4.html">XFCE4 (1)</a></li>
          <li><a href="../tag/xorg.html">Xorg (2)</a></li>
        </ul>
      </nav>
      <ul class="social">
          <li>
            <a  class="sc-linkedin" href="https://be.linkedin.com/in/frederic-gerard-32092754" target="_blank">
            <i class="fab fa-linkedin">
            </i>
          </a></li>
          <li>
            <a  class="sc-rss" href="https://thebigfred.github.io/feeds/all.atom.xml" target="_blank">
            <i class="fas fa-rss">
            </i>
          </a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="../index.html"><span class="fa fa-home"> Home</a>
  - <span class="fa fa-folder-open-o" ></span> devtools
      <hr>
    </nav>

<article class="single">
  <header>
      <div class="toc"><span class="toctitle">Content</span><ul>
<li><a href="#premier-exemple">Premier exemple</a></li>
<li><a href="#les-bases">Les bases</a></li>
</ul>
</div>
      
    <h1 id="introduction-a-cmake">Introduction à CMake</h1>
    <p>
      Posté le Lun 29 avril 2019 dans <a href="../category/devtools.html">devtools</a>

        <br>Article de la série  :
    </p>
  </header>

  <div>
    
<p>CMake est un outil open-source et cross-platform qui permet la gestion du processus de compilation d'une application et ce de manière indépendante du système d'exploitation et du compilateur utilisé.</p>
<p>En bref, vous écrivez un simple fichier texte nommé CMakeLists.txt qui décrit votre projet et cmake vous générera un projet à base de makefile ou ninja, un projet Eclipse, un projet Visual Studio, ...</p>
<p>Il est possible de construire des applications, des bibliothèques statique et/ou dynamique, d'automatisé l'exécution de tests unitaires et bien d'autres choses.</p>
<p>Les langages supportés <em>out of the box</em> sont le C, C++, CUDA, Fortran et l'assembleur.</p>
<p>CMake est extensible par le biais de modules existants que l'on peut charger, ou par le biais de modules que l'on peut écrire soit même.</p>
<p>Il existe par exemple des modules permettant de prendre en charge d'autres langages comme python, java ou latex.</p>
<p>A mes début en cmake, l'inconvénient majeur était la documentation. Il n'y avait pas de tutoriel officiel. On trouve également beaucoup de tuto ou de post sur les forums avec des pratiques qualifiées de mauvaises depuis la version 3.0.</p>
<p>Depuis cette version 3.0, on parle de <a href="https://cliutils.gitlab.io/modern-cmake"><em>Modern cmake</em></a> et c'est "la bonne pratique" à suivre.</p>
<p>Depuis la version 3.16, il existe un <a href="https://cmake.org/cmake/help/v3.16/guide/tutorial/index.html">tuto officiel</a>.</p>
<h2 id="premier-exemple">Premier exemple</h2>
<p>Écrivez le code suivant dans un fichier texte que vous nommerez <em>CMakeLists.txt</em></p>
<div class="highlight"><pre><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.0.2</span><span class="p">)</span>   <span class="c"># définit la version minimum de cmake</span>
<span class="nb">project</span><span class="p">(</span><span class="s">MonApplication</span><span class="p">)</span>                 <span class="c"># Configure le nom du projet</span>
<span class="nb">add_executable</span><span class="p">(</span><span class="s">app01</span> <span class="s">main.cpp</span><span class="p">)</span>          <span class="c"># Création d'une application app01 depuis main.cpp</span>
</pre></div>
<p>Créer un fichier le <em>main.cpp</em></p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{}</span>
</pre></div>
<p>Dans une console, dans le dossier contenant votre <em>CMakeLists.txt</em> et un fichier main.cpp, tapez <strong>cmake .</strong></p>
<div class="highlight"><pre><span></span><span class="gp">$</span> cmake .
<span class="go">-- The C compiler identification is GNU 9.3.0</span>
<span class="go">-- The CXX compiler identification is GNU 9.3.0</span>
<span class="go">-- Check for working C compiler: /usr/bin/cc</span>
<span class="go">-- Check for working C compiler: /usr/bin/cc - works</span>
<span class="go">-- Detecting C compiler ABI info</span>
<span class="go">-- Detecting C compiler ABI info - done</span>
<span class="go">-- Detecting C compile features</span>
<span class="go">-- Detecting C compile features - done</span>
<span class="go">-- Check for working CXX compiler: /usr/bin/c++</span>
<span class="go">-- Check for working CXX compiler: /usr/bin/c++ - works</span>
<span class="go">-- Detecting CXX compiler ABI info</span>
<span class="go">-- Detecting CXX compiler ABI info - done</span>
<span class="go">-- Detecting CXX compile features</span>
<span class="go">-- Detecting CXX compile features - done</span>
<span class="go">-- Configuring done</span>
<span class="go">-- Generating done</span>
<span class="go">-- Build files have been written to: /home/fred/cmake/exp01</span>
<span class="gp">$</span>
</pre></div>
<p>Nous venons de générer un projet makefile.</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ls -1 
<span class="go">CMakeCache.txt         </span>
<span class="go">CMakeFiles</span>
<span class="go">cmake_install.cmake</span>
<span class="go">CMakeLists.txt         # Notre fichier CMakeLists.txt</span>
<span class="go">main.cpp               # Les sources de notre application</span>
<span class="go">Makefile</span>
</pre></div>
<p>Il n'y a plus qu'à compiler notre application.</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> make
<span class="go">Scanning dependencies of target app01</span>
<span class="go">[ 50%] Building CXX object CMakeFiles/app01.dir/main.cpp.o</span>
<span class="go">[100%] Linking CXX executable app01</span>
<span class="go">[100%] Built target app01</span>
<span class="gp">$</span>
</pre></div>
<p>Une manière plus <em>propre</em> de travailler est de générer les fichiers cmake dans un répertoire différent.
Soit dans un sous dossier des sources, soit un dossier en dehors des sources.</p>
<p>Il y a deux manières de procéder :</p>
<ul>
<li>Vous vous placez dans le dossier de <em>compilation</em> et vous indiquez à cmake où se trouve le fichier CMakeLists.txt.</li>
<li>Vous utilisez les options -S et -B de cmake pour indiquer respectivement, le dossier des sources et le de dossier de build.</li>
</ul>
<blockquote>
<p>Supprimer les fichiers générer entre chaque exemple.</p>
</blockquote>
<p>Méthode 1</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> <span class="nv">$HOME</span>/cmake/exp01      <span class="c1"># Le dossier des sources</span>
<span class="gp">$</span> mkdir build               <span class="c1"># Création d'un sous dossier de compilation</span>
<span class="gp">$</span> <span class="nb">cd</span> build                  <span class="c1"># On se déplace dans le dossier build</span>
<span class="gp">$</span> cmake ..                  <span class="c1"># Exécution de cmake avec le path (ici relatif) des sources</span>
<span class="go">...</span>
</pre></div>
<p>Ou encore</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> mkdir <span class="nv">$HOME</span>/build         <span class="c1"># Création d'un dossier de compilation hors des sources</span>
<span class="gp">$</span> <span class="nb">cd</span> <span class="nv">$HOME</span>/build            <span class="c1"># On se déplace dans le dossier build</span>
<span class="gp">$</span> cmake <span class="nv">$HOME</span>/cmake/exp01   <span class="c1"># Exécution de cmake avec le path des sources</span>
<span class="go">...</span>
</pre></div>
<p>Méthode 2</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> mkdir <span class="nv">$HOME</span>/build
<span class="gp">$</span> cmake -S <span class="nv">$HOME</span>/cmake/exp01 -B <span class="nv">$HOME</span>/build
<span class="go">...</span>
</pre></div>
<h2 id="les-bases">Les bases</h2>
<p>Dans notre premier CMakeLists.txt, la commande <strong>add_executable(app01 main.cpp)</strong> crée une cible (ou target en anglais) <em>app01</em>.</p>
<p>Pour moi, les targets cmake sont similaires aux targets des makefiles :</p>
<ul>
<li>elles reprennent un ensemble de fichiers à compiler ;</li>
<li>elles reprennent un ensemble d'options qui seront passées au pré-processeur, compilateur, éditeur de liens et assembleur.</li>
</ul>
<p>Il est également possible de définir certaines options de manière globale au CMakeLists.txt.</p>
<blockquote>
<p>C'est ici qu'il faut prendre les bonnes habitudes. Ne toucher pas aux options globales de compilation, mais uniquement aux targets !!!</p>
</blockquote>
<p>Lorsque l'on écrit un cmake, il faut garder à l'esprit, qu'il pourrait être appelé depuis un autre CMakeLists.txt. En assignant une valeur à une option globale, on écrase éventuellement des valeurs déjà configurées dans le CMakeLists de plus haut niveau et vous imposez ces valeurs aux autres targets.</p>
<div class="highlight"><pre><span></span><span class="nb">compile_options</span><span class="p">(</span><span class="s">-Wall</span> <span class="s">-Wextra</span> <span class="s">-O3</span><span class="p">)</span>    <span class="c"># option globale</span>
<span class="nb">target_compile_options</span><span class="p">(</span><span class="s">app01</span> <span class="s">-O0</span><span class="p">)</span>     <span class="c"># option pour la target app01</span>
</pre></div>
<h3>second exemple</h3>
<div class="highlight"><pre><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.14</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="s">App02</span> <span class="s">VERSION</span> <span class="s">1.0.0.0</span> <span class="s">LANGUAGES</span> <span class="s">CXX</span><span class="p">)</span>

<span class="c"># Définition de la target</span>
<span class="nb">add_executable</span><span class="p">(</span>         <span class="c"># Equivalent de _gcc -o App02 main.cpp alog.cpp algo.h_</span>
    <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>     <span class="c"># Variable cmake contenant le nom du projet</span>
    <span class="s">main.cpp</span>            <span class="c"># Liste des fichiers sources</span>
    <span class="s">algo.cpp</span>
    <span class="s">algo.h</span>
<span class="p">)</span>

<span class="c"># Les flags CFLAGS &amp; CXXFLAGS</span>
<span class="nb">target_compile_options</span><span class="p">(</span>
    <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span> <span class="s">PRIVATE</span>
    <span class="s">-Wall</span> <span class="s">-Wextra</span> <span class="s">-fmessage-length=0</span>
    <span class="o">$&lt;</span><span class="nv">$&lt;CONFIG:DEBUG</span><span class="o">&gt;</span><span class="s">:-O0&gt;</span>         <span class="c"># options utilisées uniquement en mode Debug</span>
    <span class="o">$&lt;</span><span class="nv">$&lt;CONFIG:RELEASE</span><span class="o">&gt;</span><span class="s">:-O3&gt;</span>       <span class="c"># options utilisées uniquement en mode Release</span>
<span class="p">)</span>

<span class="c"># Forcer l'utilisation de C++11</span>
<span class="nb">set_property</span><span class="p">(</span>                       <span class="c"># on utilise pas l'option -std=c++11</span>
    <span class="s">TARGET</span> <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
    <span class="s">PROPERTY</span> <span class="s">CXX_STANDARD</span> <span class="s">11</span>
<span class="p">)</span>

<span class="c"># -D : define</span>
<span class="nb">target_compile_definitions</span><span class="p">(</span>         <span class="c"># Equivalent de gcc -DDEBUG</span>
    <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
    <span class="o">$&lt;</span><span class="nv">$&lt;CONFIG:DEBUG</span><span class="o">&gt;</span><span class="s">:DEBUG&gt;</span>        <span class="c"># define utilisées uniquement en mode Debug</span>
<span class="p">)</span>

<span class="c"># -I : include path</span>
<span class="nb">target_include_directories</span><span class="p">(</span>         <span class="c"># Equivalent de gcc -I/opt/libXYZ</span>
    <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>                 <span class="c"># On verra plus tard comment éviter</span>
    <span class="s">/opt/LIBXYZ</span>                     <span class="c"># d'indiquer un path absolut</span>
<span class="p">)</span>

<span class="c"># -l : link </span>
<span class="nb">target_link_libraries</span><span class="p">(</span>              <span class="c"># Equivalent de -lm -lncurses</span>
    <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>                 <span class="c"># Ici les lib utilisées sont des lib de l'OS</span>
    <span class="s">m</span>                               <span class="c"># On verra plus tard comment ajouter des libs tiers</span>
    <span class="s">ncurses</span>
<span class="p">)</span>

<span class="c"># Directive d'installation</span>
<span class="nb">install</span><span class="p">(</span><span class="s">TARGETS</span> <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span> <span class="s">DESTINATION</span> <span class="s">bin</span><span class="p">)</span>
</pre></div>
<p>project</p>
<h3>Options de compilation</h3>
<p>target_compile_options
set_property(
    TARGET ${PROJECT_NAME}
    PROPERTY CXX_STANDARD 11
)</p>
<h3>define</h3>
<p>target_compile_definitions</p>
<h3>include path</h3>
<p>target_include_directories</p>
<h3>library path</h3>
<p>find_library &amp; find_package</p>
<h3>link</h3>
<p>target_link_libraries</p>
<h3>install</h3>
<p>install(TARGETS ${PROJECT_NAME} DESTINATION bin)</p>
<h3>variables définies par cmake</h3>
<p>${PROJECT_NAME}
${CMAKE_CURRENT_SOURCE_DIR}
 ${CMAKE_CURRENT_BINARY_DIR}</p>
<h3>variables</h3>
<p>set(SOURCE_FILES
    main.cpp
)</p>
<h3>options</h3>
<p>option(ENABLE_YYYY        "Enable YYYY"                OFF)
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/config.h.in 
    ${CMAKE_CURRENT_BINARY_DIR}/config.h
)</p>
  </div>
  <header><p>
        <br>Série  :
  </p></header>
  <div class="tag-cloud">
    <p>
      <span class="fa fa-tags" ></span> 
      <a href="../tag/cmd-line.html">cmd-line</a>
      <a href="../tag/gnu-tools.html">GNU-Tools</a>
    </p>
  </div>





<!-- gittalk -->
<div id="gitalk-container"></div>
<script type="text/javascript">
	const gitalk = new Gitalk({
		clientID: 'ff500cd58d3176eccb54',
		clientSecret: 'c5f7d6a38b1cc73dea3b02a075e8630eaad15617',
		repo: 'comments',      // The repository of store comments,
		owner: 'TheBigFred',
		admin: ['TheBigFred'],
		id:window.location.pathname,      // Ensure uniqueness and length less than 50
		distractionFreeMode: false  // Facebook-like distraction free mode
	})

	gitalk.render('gitalk-container')
</script>
<noscript>
    Veuillez activer le JavaScript pour voir les commentaires.
</noscript>
<!-- End gittalk -->
</article>

    <footer>
<p>
  &copy; FGE 2016 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Propulsé par <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> thème par <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " fgeDoc's ",
  "url" : "..",
  "image": "",
  "description": "FGE's Thoughts and Writings"
}
</script>

</body>
</html>